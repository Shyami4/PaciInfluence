
// Looking at the Cutomer Types within an Organization
SELECT ORGANIZATION_ID, 
CUSTOMER_TYPE_NAME, 
COUNT(ORGANIZATION_ID) AS COUNT
FROM INFOMART.DIM_ACCOUNT 
WHERE ORGANIZATION_ID IN (
    'UCLA', 'ALABAMA', 'ARIZONA', 'AUBURN', 'USC', 'WISCONSIN',
    'MICHIGAN', 'NEBRASKA', 'CAL', 'PURDUE', 'NCSU', 'COLORADO',
    'WASHINGTON', 'BEAVERS', 'RICHMOND', 'USAF', 'OKLAHOMA',
    'NAVY', 'TTU', 'EMICH', 'WASHST'
)
GROUP BY ORGANIZATION_ID, CUSTOMER_TYPE_NAME
ORDER BY ORGANIZATION_ID

//Looking at the dim_tk_event tale to understand the event oragnized by the organizations
select * from infomart.dim_tk_event
WHERE ORGANIZATION_ID IN ('UCLA')

SELECT A.ORGANIZATION_ID, 
A.EGROUP_ID_NAME,
B.DESCRIPTION:en_US AS ORG_DESCRIPTION,
FROM INFOMART.DIM_TK_EVENT A
LEFT JOIN INFOMART.DIM_ORGANIZATION B
ON A.ORGANIZATION_ID = B.ORGANIZATION_ID
WHERE A.ORGANIZATION_ID IN (
    'UCLA', 'ALABAMA', 'ARIZONA', 'AUBURN', 'USC', 'WISCONSIN',
    'MICHIGAN', 'NEBRASKA', 'CAL', 'PURDUE', 'NCSU', 'COLORADO',
    'WASHINGTON', 'BEAVERS', 'RICHMOND', 'USAF', 'OKLAHOMA',
    'NAVY', 'TTU', 'EMICH', 'WASHST'
)
GROUP BY A.ORGANIZATION_ID, A.EGROUP_ID_NAME, ORG_DESCRIPTION
ORDER BY A.ORGANIZATION_ID;


------------------------------------------------------------------------------------------
// INFOMART.DIM_ORGANIZATION
------------------------------------------------------------------------------------------

// Looking at the organization in Paciolan
SELECT ORGANIZATION_ID, 
NAME:en_US::STRING AS ORGNIZATION_NAME,
NAME_FSS, 
MARKET, 
DESCRIPTION:en_US::STRING,
FROM INFOMART.DIM_ORGANIZATION
GROUP BY ORGANIZATION_ID, NAME, NAME_FSS, MARKET,DESCRIPTION;


//Looking at count of organizations by Market Type
SELECT MARKET,
COUNT(DIM_ORGANIZATION_KEY) AS ORGANIZATION_COUNT
FROM INFOMART.DIM_ORGANIZATION
GROUP BY MARKET;

------------------------------------------------------------------------------------------
// DIM_ACCOUNT
------------------------------------------------------------------------------------------
// Looking at the DIM_ACCOUNT table
SELECT ORGANIZATION_ID, 
CUSTOMER_TYPE, 
CUSTOMER_TYPE_NAME, 
ACCOUNT_STATUS_ID, STATUS:en_US::STRING, 
TYPE_CODE, TYPE_NAME:en_US::STRING
FROM INFOMART.DIM_ACCOUNT 
WHERE ORGANIZATION_ID IN (
    'UCLA', 'ALABAMA', 'ARIZONA', 'AUBURN', 'USC', 'WISCONSIN',
    'MICHIGAN', 'NEBRASKA', 'CAL', 'PURDUE', 'NCSU', 'COLORADO',
    'WASHINGTON', 'BEAVERS', 'RICHMOND', 'USAF', 'OKLAHOMA',
    'NAVY', 'TTU', 'EMICH', 'WASHST'
)
GROUP BY ORGANIZATION_ID,CUSTOMER_TYPE, CUSTOMER_TYPE_NAME, ACCOUNT_STATUS_ID, STATUS, TYPE_CODE, TYPE_NAME
ORDER BY ORGANIZATION_ID;


// Getting the number of accounts for the 21 oranizations (excluding the delected accounts)
SELECT ORGANIZATION_ID, COUNT(DIM_ACCOUNT_KEY) AS ACCOUNT_COUNT
FROM INFOMART.DIM_ACCOUNT 
WHERE ORGANIZATION_ID IN (
    'UCLA', 'ALABAMA', 'ARIZONA', 'AUBURN', 'USC', 'WISCONSIN',
    'MICHIGAN', 'NEBRASKA', 'CAL', 'PURDUE', 'NCSU', 'COLORADO',
    'WASHINGTON', 'BEAVERS', 'RICHMOND', 'USAF', 'OKLAHOMA',
    'NAVY', 'TTU', 'EMICH', 'WASHST'
)
AND IS_DELETED != True
GROUP BY ORGANIZATION_ID
ORDER BY ACCOUNT_COUNT DESC;

// Exploring the Account Type in the 21 organizations in the DIM_AACOUNT Table
SELECT ORGANIZATION_ID, TYPE_CODE, TYPE_NAME:en_US::STRING, COUNT(DIM_ACCOUNT_KEY) AS ACCOUNT_COUNT
FROM INFOMART.DIM_ACCOUNT 
WHERE ORGANIZATION_ID IN (
    'UCLA', 'ALABAMA', 'ARIZONA', 'AUBURN', 'USC', 'WISCONSIN',
    'MICHIGAN', 'NEBRASKA', 'CAL', 'PURDUE', 'NCSU', 'COLORADO',
    'WASHINGTON', 'BEAVERS', 'RICHMOND', 'USAF', 'OKLAHOMA',
    'NAVY', 'TTU', 'EMICH', 'WASHST'
)
AND IS_DELETED != True
GROUP BY ORGANIZATION_ID, TYPE_CODE, TYPE_NAME:en_US
ORDER BY ORGANIZATION_ID, ACCOUNT_COUNT;

// Exploring the Account Type = Null to understand the nature of the records
// Found that these are the deleted accounts with IS_DELETED = True

// Exploring the Account Status's in the 21 organizations in the DIM_AACOUNT Table
SELECT ORGANIZATION_ID,
ACCOUNT_STATUS_ID,STATUS:en_US 
FROM INFOMART.DIM_ACCOUNT 
WHERE ORGANIZATION_ID IN (
    'UCLA', 'ALABAMA', 'ARIZONA', 'AUBURN', 'USC', 'WISCONSIN',
    'MICHIGAN', 'NEBRASKA', 'CAL', 'PURDUE', 'NCSU', 'COLORADO',
    'WASHINGTON', 'BEAVERS', 'RICHMOND', 'USAF', 'OKLAHOMA',
    'NAVY', 'TTU', 'EMICH', 'WASHST'
)
GROUP BY ORGANIZATION_ID, ACCOUNT_STATUS_ID, STATUS
ORDER BY ORGANIZATION_ID

// Finding the number of accounts for the 21 organizations (With LEFT JOIN to get Org Description)
select A.ORGANIZATION_ID, 
B.DESCRIPTION:en_US::STRING AS ORGANIZATION_DESC,
COUNT(A.ORGANIZATION_ID) AS NUM_OF_ACCOUNTS
from infomart.dim_account A
LEFT JOIN INFOMART.DIM_ORGANIZATION B
ON A.ORGANIZATION_ID = B.ORGANIZATION_ID
WHERE A.ORGANIZATION_ID IN (
    'UCLA', 'ALABAMA', 'ARIZONA', 'AUBURN', 'USC', 'WISCONSIN',
    'MICHIGAN', 'NEBRASKA', 'CAL', 'PURDUE', 'NCSU', 'COLORADO',
    'WASHINGTON', 'BEAVERS', 'RICHMOND', 'USAF', 'OKLAHOMA',
    'NAVY', 'TTU', 'EMICH', 'WASHST'
)
AND A.IS_DELETED != True
GROUP BY A.ORGANIZATION_ID,
B.DESCRIPTION:en_US
ORDER BY NUM_OF_ACCOUNTS DESC;


// To get the count of customer type across the 21 organizations
SELECT A.ORGANIZATION_ID, 
B.DESCRIPTION:en_US::STRING AS ORGANIZATION_DESC,
COUNT(DISTINCT(A.CUSTOMER_TYPE)) AS CUSTOMER_TYPE_COUNT
FROM INFOMART.DIM_ACCOUNT A
LEFT JOIN INFOMART.DIM_ORGANIZATION B
ON A.ORGANIZATION_ID = B.ORGANIZATION_ID
WHERE A.ORGANIZATION_ID IN (
    'UCLA', 'ALABAMA', 'ARIZONA', 'AUBURN', 'USC', 'WISCONSIN',
    'MICHIGAN', 'NEBRASKA', 'CAL', 'PURDUE', 'NCSU', 'COLORADO',
    'WASHINGTON', 'BEAVERS', 'RICHMOND', 'USAF', 'OKLAHOMA',
    'NAVY', 'TTU', 'EMICH', 'WASHST'
)
GROUP BY A.ORGANIZATION_ID, ORGANIZATION_DESC
ORDER BY CUSTOMER_TYPE_COUNT DESC;


// Not useful
select distinct ORGANIZATION_ID, 
COUNT(ORGANIZATION_ID), 
CUSTOMER_TYPE_NAME,
TYPE_NAME
from infomart.dim_account
WHERE ORGANIZATION_ID IN (
    'UCLA', 'ALABAMA', 'ARIZONA', 'AUBURN', 'USC', 'WISCONSIN',
    'MICHIGAN', 'NEBRASKA', 'CAL', 'PURDUE', 'NCSU', 'COLORADO',
    'WASHINGTON', 'BEAVERS', 'RICHMOND', 'USAF', 'OKLAHOMA',
    'NAVY', 'TTU', 'EMICH', 'WASHST'
)
GROUP BY ORGANIZATION_ID,
CUSTOMER_TYPE_NAME,
TYPE_NAME;

------------------------------------------------------------------------------------------
// DIM_DONOR
------------------------------------------------------------------------------------------
SELECT * FROM INFOMART.DIM_DONOR
LIMIT 5

SELECT DISTINCT(DONOR_TYPE), DONOR_TYPE_NAME FROM INFOMART.DIM_DONOR

SELECT DISTINCT(DONOR_TYPE), DONOR_TYPE_NAME FROM INFOMART.DIM_DONOR

// Looking at the aggregate of various gift amounts from DONOR table
SELECT A.ORGANIZATION_ID,
B.DESCRIPTION:en_US::STRING AS ORGANIZATION_DESC,
COUNT(A.DIM_ACCOUNT_KEY) AS DONOR_ACCOUNT_COUNT,
MAX(A.GREATEST_GIFT_AMOUNT) AS MAX_GREATEST_GIFT_AMOUNT,
MAX(A.LIFETIME_DONATION_AMOUNT) AS MAX_LIFETIME_DONATION_AMOUNT,
AVG(A.LIFETIME_DONATION_AMOUNT) AS AVG_LIFETIME_DONATION_AMOUNT
FROM INFOMART.DIM_DONOR A
LEFT JOIN INFOMART.DIM_ORGANIZATION B
ON A.ORGANIZATION_ID = B.ORGANIZATION_ID
WHERE A.ORGANIZATION_ID IN (
    'UCLA', 'ALABAMA', 'ARIZONA', 'AUBURN', 'USC', 'WISCONSIN',
    'MICHIGAN', 'NEBRASKA', 'CAL', 'PURDUE', 'NCSU', 'COLORADO',
    'WASHINGTON', 'BEAVERS', 'RICHMOND', 'USAF', 'OKLAHOMA',
    'NAVY', 'TTU', 'EMICH', 'WASHST'
)
GROUP BY A.ORGANIZATION_ID, ORGANIZATION_DESC


// TEST
SELECT ORGANIZATION_ID, LIFETIME_DONATION_AMOUNT
FROM INFOMART.DIM_DONOR
WHERE ORGANIZATION_ID = 'UCLA'
ORDER BY LIFETIME_DONATION_AMOUNT DESC

SELECT ORGANIZATION_ID, SUM(LIFETIME_DONATION_AMOUNT)
FROM INFOMART.DIM_DONOR
WHERE ORGANIZATION_ID = 'UCLA'
GROUP BY ORGANIZATION_ID


SELECT DISTINCT(DONOR_TYPE_NAME) FROM  INFOMART.DIM_DONOR

------------------------------------------------------------------------------------------
// INFOMART.DIM_TK_ACTIVITY
------------------------------------------------------------------------------------------
//Groups Activities across the 21 organizations
SELECT A.ORGANIZATION_ID,
B.DESCRIPTION:en_US::STRING AS ORGANIZATION_DESC,
A.ACTIVITY_ID,
A.NAME
FROM INFOMART.DIM_TK_ACTIVITY A
LEFT JOIN INFOMART.DIM_ORGANIZATION B
ON A.ORGANIZATION_ID = B.ORGANIZATION_ID
WHERE A.ORGANIZATION_ID IN (
    'UCLA', 'ALABAMA', 'ARIZONA', 'AUBURN', 'USC', 'WISCONSIN',
    'MICHIGAN', 'NEBRASKA', 'CAL', 'PURDUE', 'NCSU', 'COLORADO',
    'WASHINGTON', 'BEAVERS', 'RICHMOND', 'USAF', 'OKLAHOMA',
    'NAVY', 'TTU', 'EMICH', 'WASHST'
)
AND A.IS_DELETED != TRUE
GROUP BY A.ORGANIZATION_ID, ORGANIZATION_DESC, A.ACTIVITY_ID, A.NAME
ORDER BY A.ORGANIZATION_ID;

// Gets the count of activity types across the 21 organizations
SELECT A.ORGANIZATION_ID,
B.DESCRIPTION:en_US::STRING AS ORGANIZATION_DESC,
COUNT(A.ACTIVITY_ID)
FROM INFOMART.DIM_TK_ACTIVITY A
LEFT JOIN INFOMART.DIM_ORGANIZATION B
ON A.ORGANIZATION_ID = B.ORGANIZATION_ID
WHERE A.ORGANIZATION_ID IN (
    'UCLA', 'ALABAMA', 'ARIZONA', 'AUBURN', 'USC', 'WISCONSIN',
    'MICHIGAN', 'NEBRASKA', 'CAL', 'PURDUE', 'NCSU', 'COLORADO',
    'WASHINGTON', 'BEAVERS', 'RICHMOND', 'USAF', 'OKLAHOMA',
    'NAVY', 'TTU', 'EMICH', 'WASHST'
)
AND A.IS_DELETED != TRUE
GROUP BY A.ORGANIZATION_ID, ORGANIZATION_DESC
ORDER BY A.ORGANIZATION_ID;
------------------------------------------------------------------------------------------
// INFOMART.DIM_TK_EVENT
------------------------------------------------------------------------------------------
SELECT A.ORGANIZATION_ID,
B.DESCRIPTION:en_US::STRING AS ORGANIZATION_DESC,
A.SEASON_ID,
A.EVENT_ID,
A.EVENT_ID_NAME,
A.ETYPE,
A.EGROUP,
A.NAME,
A.CLASS_NAME,
A.DATE,
YEAR(A.DATE) AS EVENT_YEAR,
A.EGROUP_NAME
FROM INFOMART.DIM_TK_EVENT A
LEFT JOIN INFOMART.DIM_ORGANIZATION B
ON A.ORGANIZATION_ID = B.ORGANIZATION_ID
WHERE A.ORGANIZATION_ID IN (
    'UCLA', 'ALABAMA', 'ARIZONA', 'AUBURN', 'USC', 'WISCONSIN',
    'MICHIGAN', 'NEBRASKA', 'CAL', 'PURDUE', 'NCSU', 'COLORADO',
    'WASHINGTON', 'BEAVERS', 'RICHMOND', 'USAF', 'OKLAHOMA',
    'NAVY', 'TTU', 'EMICH', 'WASHST'
)
AND A.IS_DELETED != TRUE
AND EVENT_YEAR >=2022
GROUP BY A.ORGANIZATION_ID, ORGANIZATION_DESC, A.EVENT_ID,
A.EVENT_ID_NAME,
A.ETYPE,
A.SEASON_ID,
A.NAME,
A.DATE,
A.CLASS_NAME,
EVENT_YEAR,
A.EGROUP_NAME, A.EGROUP
ORDER BY A.ORGANIZATION_ID, A.season_id;


// Selecting the top activity for each of the 21 organizations based on the most number of event since 2022
// Uses a subquery which selects from DIM_TK_SEASON, DIM_TK_ACTIVITY and DIM_TK_EVENT
// Uses PARTITION and RANK in the subquery
SELECT D.ORGANIZATION_ID, 
E.DESCRIPTION:en_US::STRING AS ORGANIZATION_DESC,
D.ACTIVITY_NAME AS TOP_ACTIVITY_NAME,
D.EVENT_COUNT_22
FROM
(
SELECT A.ORGANIZATION_ID,
A.ACTIVITY_ID,
C.NAME AS ACTIVITY_NAME,
COUNT(B.DIM_TK_EVENT_KEY) AS EVENT_COUNT_22,
RANK() OVER (PARTITION BY A.ORGANIZATION_ID ORDER BY COUNT(B.DIM_TK_EVENT_KEY) DESC) AS EVENT_RANK
FROM INFOMART.DIM_TK_SEASON A
RIGHT JOIN INFOMART.DIM_TK_EVENT B
ON A.ORGANIZATION_ID = B.ORGANIZATION_ID
AND A.SEASON_ID = B.SEASON_ID
LEFT JOIN INFOMART.DIM_TK_ACTIVITY C
ON A.ACTIVITY_ID = C.ACTIVITY_ID
AND A.ORGANIZATION_ID = C.ORGANIZATION_ID
WHERE YEAR(B.DATE) >= 2022
AND A.ORGANIZATION_ID IN (
    'UCLA', 'ALABAMA', 'ARIZONA', 'AUBURN', 'USC', 'WISCONSIN',
    'MICHIGAN', 'NEBRASKA', 'CAL', 'PURDUE', 'NCSU', 'COLORADO',
    'WASHINGTON', 'BEAVERS', 'RICHMOND', 'USAF', 'OKLAHOMA',
    'NAVY', 'TTU', 'EMICH', 'WASHST'
)
GROUP BY A.ACTIVITY_ID, A.ORGANIZATION_ID, ACTIVITY_NAME
ORDER BY A.ORGANIZATION_ID, EVENT_RANK
) D
LEFT JOIN INFOMART.DIM_ORGANIZATION E
ON D.ORGANIZATION_ID = E.ORGANIZATION_ID
WHERE D.ORGANIZATION_ID IN (
    'UCLA', 'ALABAMA', 'ARIZONA', 'AUBURN', 'USC', 'WISCONSIN',
    'MICHIGAN', 'NEBRASKA', 'CAL', 'PURDUE', 'NCSU', 'COLORADO',
    'WASHINGTON', 'BEAVERS', 'RICHMOND', 'USAF', 'OKLAHOMA',
    'NAVY', 'TTU', 'EMICH', 'WASHST'
)
AND D.EVENT_RANK = 1;


------------------------------------------------------------------------------------------
// INFOMART_EXT.FACT_TICKET_TRANSFER
------------------------------------------------------------------------------------------

SELECT * FROM INFOMART_EXT.FACT_TICKET_TRANSFER 
WHERE ORGANIZATION_ID = 'UCLA'
AND YEAR(SEND_DATETIME) >=2022
AND ACCEPT_DATETIME IS NOT NULL
LIMIT 100;

//Selects unique pair of senders and receivers and no of transfers between them, filtered by the 21 universities.
// Focussing on tranfer 2022 onwards only and where ACCEPT_DATETIME is not NULL.
SELECT DISTINCT(A.DIM_ACCOUNT_KEY) AS SENDER_DIM_ACCOUNT_KEY,
A.ORGANIZATION_ID, 
C.DESCRIPTION:en_US::STRING AS ORGANIZATION_DESC,
COUNT(A.TRANSFER_KEY),
B.DIM_ACCOUNT_KEY AS RECEPIENT_DIM_ACCOUNT_KEY, 
FROM infomart_ext.fact_ticket_transfer A 
LEFT JOIN  infomart.DIM_ACCOUNT B
ON A.RECEP_ACCOUNT_ID = B.ACCOUNT_ID
AND A.ORGANIZATION_ID = B.ORGANIZATION_ID
LEFT JOIN INFOMART.DIM_ORGANIZATION C
ON A.ORGANIZATION_ID = C.ORGANIZATION_ID
WHERE A.ORGANIZATION_ID IN (
    'UCLA', 'ALABAMA', 'ARIZONA', 'AUBURN', 'USC', 'WISCONSIN',
    'MICHIGAN', 'NEBRASKA', 'CAL', 'PURDUE', 'NCSU', 'COLORADO',
    'WASHINGTON', 'BEAVERS', 'RICHMOND', 'USAF', 'OKLAHOMA',
    'NAVY', 'TTU', 'EMICH', 'WASHST'
)
AND YEAR(SEND_DATETIME) >=2022
AND ACCEPT_DATETIME IS NOT NULL
GROUP BY SENDER_DIM_ACCOUNT_KEY,
A.ORGANIZATION_ID,
C.DESCRIPTION,
RECEPIENT_DIM_ACCOUNT_KEY;



/// To get an overview of the number of transfers happening since 2022 at ecah of the 21 organizations
SELECT A.ORGANIZATION_ID, 
C.DESCRIPTION:en_US::STRING AS ORGANIZATION_DESC,
COUNT(A.TRANSFER_KEY) TRANSFER_COUNT_22_25,
FROM infomart_ext.fact_ticket_transfer A 
LEFT JOIN INFOMART.DIM_ORGANIZATION C
ON A.ORGANIZATION_ID = C.ORGANIZATION_ID
WHERE A.ORGANIZATION_ID IN (
    'UCLA', 'ALABAMA', 'ARIZONA', 'AUBURN', 'USC', 'WISCONSIN',
    'MICHIGAN', 'NEBRASKA', 'CAL', 'PURDUE', 'NCSU', 'COLORADO',
    'WASHINGTON', 'BEAVERS', 'RICHMOND', 'USAF', 'OKLAHOMA',
    'NAVY', 'TTU', 'EMICH', 'WASHST'
)
AND YEAR(SEND_DATETIME) >=2022
AND ACCEPT_DATETIME IS NOT NULL
GROUP BY 
A.ORGANIZATION_ID,
C.DESCRIPTION
ORDER BY TRANSFER_COUNT_22_25 DESC;



// Focussing on getting the sender-recepient transaction count for UCLA
// UCLA being the top org out of the 21 with the most number of accounts.
SELECT DISTINCT(A.DIM_ACCOUNT_KEY) AS SENDER_DIM_ACCOUNT_KEY,
A.ORGANIZATION_ID, 
C.DESCRIPTION:en_US::STRING AS ORGANIZATION_DESC,
COUNT(A.TRANSFER_KEY),
B.DIM_ACCOUNT_KEY AS RECEPIENT_DIM_ACCOUNT_KEY, 
FROM infomart_ext.fact_ticket_transfer A 
LEFT JOIN  infomart.DIM_ACCOUNT B
ON A.RECEP_ACCOUNT_ID = B.ACCOUNT_ID
AND A.ORGANIZATION_ID = B.ORGANIZATION_ID
LEFT JOIN INFOMART.DIM_ORGANIZATION C
ON A.ORGANIZATION_ID = C.ORGANIZATION_ID
WHERE A.ORGANIZATION_ID IN ('UCLA')
AND YEAR(SEND_DATETIME) >=2022
AND ACCEPT_DATETIME IS NOT NULL
GROUP BY SENDER_DIM_ACCOUNT_KEY,
A.ORGANIZATION_ID,
C.DESCRIPTION,
RECEPIENT_DIM_ACCOUNT_KEY;



//Creating the edge file for the senders and recipients from UCLA, with name and zip code details too.
//Focussing on transfers after 2022
SELECT DISTINCT(A.DIM_ACCOUNT_KEY) AS SENDER_DIM_ACCOUNT_KEY,
A.ACCOUNT_NAME AS SENDER_NAME,
B.TYPE_NAME:en_US::STRING,
A.ORGANIZATION_ID, 
A.ORGANIZATION_NAME,
COUNT(A.TRANSFER_KEY),
B.DIM_ACCOUNT_KEY AS RECEPIENT_DIM_ACCOUNT_KEY, 
B.NAME AS RECEPIENT_NAME,
C.TICKET_BILLING_ZIP
FROM infomart_ext.fact_ticket_transfer A 
LEFT JOIN  infomart.DIM_ACCOUNT B
ON A.RECEP_ACCOUNT_ID = B.ACCOUNT_ID
AND A.ORGANIZATION_ID = B.ORGANIZATION_ID
LEFT JOIN INFOMART_EXT.DIM_ACCOUNT_CONTACT_ADDRESS C
ON A.DIM_ACCOUNT_KEY = C.DIM_ACCOUNT_KEY
WHERE A.ORGANIZATION_ID IN (
  'UCLA'
)
AND YEAR(SEND_DATETIME) >=2022
AND ACCEPT_DATETIME IS NOT NULL
GROUP BY SENDER_DIM_ACCOUNT_KEY,
A.ACCOUNT_NAME,
B.TYPE_NAME,
A.ORGANIZATION_ID,
A.ORGANIZATION_NAME,
C.TICKET_BILLING_ZIP,
RECEPIENT_DIM_ACCOUNT_KEY,
RECEPIENT_NAME
HAVING COUNT(A.TRANSFER_KEY) > 5;


//Edge File for Gephi - with just Source Target and Weight AND WITH MORE THEN 10 TRANSFERS SINCE 2022
SELECT DISTINCT(A.DIM_ACCOUNT_KEY) AS SOURCE,
B.DIM_ACCOUNT_KEY AS TARGET, 
COUNT(A.TRANSFER_KEY) AS WEIGHT,
FROM infomart_ext.fact_ticket_transfer A 
LEFT JOIN  infomart.DIM_ACCOUNT B
ON A.RECEP_ACCOUNT_ID = B.ACCOUNT_ID
AND A.ORGANIZATION_ID = B.ORGANIZATION_ID
WHERE A.ORGANIZATION_ID IN ('UCLA')
AND YEAR(SEND_DATETIME) >=2022
AND ACCEPT_DATETIME IS NOT NULL
GROUP BY SOURCE,
TARGET
HAVING COUNT(A.TRANSFER_KEY) > 10;


//Creating the Nodes file using a temporary table.
CREATE TEMPORARY TABLE nodes_1 (id VARCHAR(32));
INSERT INTO nodes_1 (id)
(SELECT DISTINCT A.DIM_ACCOUNT_KEY A
FROM infomart_ext.fact_ticket_transfer A 
WHERE A.ORGANIZATION_ID IN (
  'UCLA'
)
AND YEAR(SEND_DATETIME) >=2022
AND ACCEPT_DATETIME IS NOT NULL);

INSERT INTO nodes_1 (id)
SELECT DISTINCT 
B.DIM_ACCOUNT_KEY
FROM infomart_ext.fact_ticket_transfer A 
LEFT JOIN  infomart.DIM_ACCOUNT B
ON A.RECEP_ACCOUNT_ID = B.ACCOUNT_ID
AND A.ORGANIZATION_ID = B.ORGANIZATION_ID
WHERE A.ORGANIZATION_ID IN (
  'UCLA'
)
AND YEAR(SEND_DATETIME) >=2022
AND ACCEPT_DATETIME IS NOT NULL;

SELECT DISTINCT id from nodes_1;

select count(*) from infomart_ext.fact_ticket_transfer where DIM_ACCOUNT_KEY = 'a770391fa3a902e629e538581b6120e6';

// 3 Year monthly data for per month transactions for UCLA

SELECT YEAR(SEND_DATETIME) AS TRANSFER_YEAR,
MONTH(SEND_DATETIME) AS TRANSFER_MONTH,
COUNT(*) AS TOTAL_TRANSFERS,
SEASON_NAME, ACTIVITY_CODE
FROM infomart_ext.fact_ticket_transfer
WHERE ORGANIZATION_ID IN ('UCLA')
AND ACCEPT_DATETIME IS NOT NULL
GROUP BY TRANSFER_YEAR, TRANSFER_MONTH, SEASON_NAME, ACTIVITY_CODE
HAVING TRANSFER_YEAR >=2022
AND TRANSFER_MONTH = 6
ORDER BY TRANSFER_YEAR, TRANSFER_MONTH;




SELECT DISTINCT CATEGORY_NAME FROM INFOMART.DIM_TK_ITEM
WHERE ORGANIZATION_ID IN (
    'UCLA', 'ALABAMA', 'ARIZONA', 'AUBURN', 'USC', 'WISCONSIN',
    'MICHIGAN', 'NEBRASKA', 'CAL', 'PURDUE', 'NCSU', 'COLORADO',
    'WASHINGTON', 'BEAVERS', 'RICHMOND', 'USAF', 'OKLAHOMA',
    'NAVY', 'TTU', 'EMICH', 'WASHST'
)
LIMIT 100


-----Amy's
-- Relations Count
select organization_id, acct_1, acct_2 , count(distinct season_code) seasoncodecnt, count(distinct season_code ||':'||event_code) event_cnt ,
count(distinct internal_seatblock) internal_seatblock_cnt from (
-- account > rec account
select organization_id, organization_id || '_' || account_id acct_1, organization_id || '_' || recep_account_id  acct_2 , season_code, event_code,  internal_seatblock
from   infomart_ext.fact_ticket_transfer  where organization_id = 'WASHST' and recep_account_id <> ''
union  = ""
--rec account > account
select organization_id, organization_id || '_' || recep_account_id acct_1, organization_id || '_' || recep_account_id  acct_2, season_code, event_code, internal_seatblock
from   infomart_ext.fact_ticket_transfer where organization_id = 'WASHST' and recep_account_id <> ''
)
group by all
having  internal_seatblock_cnt > 5
limit 1000

select * from infomart.fact_tk_odet
where dim_account_key = 'dc44b35fdebd185c6c636d958281e05f';

select * from infomart.FACT_TK_ACTIVITY_SEASON
where organization_id = 'UCLA'

SELECT *
FROM infomart.fact_tk_activity_season a
left join infomart.dim_tk_activity b
on a.dim_tk_activity_key = b.dim_tk_activity_key
left join infomart.dim_tk_season c
on a.dim_tk_season_key = c.dim_tk_season_key
where a.organization_id = 'UCLA'

select * from infomart.dim_tk_season
where organization_id = 'UCLA'

select activity_id, count(name) as count_name, name from infomart.dim_tk_season
where organization_id = 'UCLA'
group by activity_id, name
order by activity_id

SELECT * FROM INFOMART.FACT_TK_ODET
WHERE DIM_ACCOUNT_KEY = 'ab0f6e2be6e022a033c7cf7c3e1eea1e'
AND I_OQTY >3 AND I_PRICE != 0.00
AND YEAR(I_DATE) > 2020


SELECT * FROM INFOMART.DIM_DONOR
WHERE DIM_ACCOUNT_KEY = 'ab0f6e2be6e022a033c7cf7c3e1eea1e'


select * from infomart.dim_tk_item_price_level
where organization_id = 'UCLA';

select * from infomart_ext.fact_ticket_transfer
where organization_id = 'UCLA'
and ACCOUNT_NAME = 'David Boctor'
limit 100;

select distinct(activity_id), name
from infomart.dim_tk_activity
where organization_id = 'WISCONSIN'
order by activity_id;

select distinct (ITEM), ITEM_NAME from infomart.dim_tk_item
where organization_id = 'UCLA'
group by item, item_name